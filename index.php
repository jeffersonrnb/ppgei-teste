<?php

/*
"374" => ADMINISTRAÇÃO (28001010020P3)
"152341" => ADMINISTRAÇÃO (28001010052P2)
"52224" => ALIMENTOS, NUTRIÇÃO E SAÚDE (28001010047P9)
"202655" => ANTROPOLOGIA (28001010058P0)
"373" => ARQUITETURA E URBANISMO (28001010019P5)
"385" => ARTES CÊNICAS (28001010035P0)
"382" => ARTES VISUAIS (28001010030P9)
"204719" => Assistência Farmacêutica (42001013102P6) (Programa em Rede)
"206788" => ASTROFÍSICA, COSMOLOGIA E GRAVITAÇÃO (30001013105P1) (Programa em Rede)
"204903" => Biociências (28001010089P3)
"204385" => BIOTECNOLOGIA (28001010080P6)
"202693" => BIOTECNOLOGIA - Rede RENORBIO (22003010017P5) (Programa em Rede)
"204325" => CECRE - Conservação e Restauração (28001010077P5)
"386" => CIÊNCIA ANIMAL NOS TRÓPICOS (28001010036P7)
"205551" => Ciência da Computação (28001010095P3)
"205000" => CIÊNCIA DA COMPUTAÇÃO - UFBA - UEFS (28001010090P1)
"202824" => CIÊNCIA DA COMPUTAÇÃO - UFBA - UNIFACS - UEFS (28001010061P1) (Programa em Rede)
"391" => CIÊNCIA DA INFORMAÇÃO (28001010041P0)
"202629" => CIÊNCIA DE ALIMENTOS (28001010057P4)
"204627" => Ciências Ambientais (28001010086P4)
"204196" => CIÊNCIAS DA SAÚDE (28001010072P3)
"377" => CIÊNCIAS SOCIAIS (28001010023P2)
"378" => COMUNICAÇÃO E CULTURA CONTEMPORÂNEA (28001010024P9)
"202867" => CONTABILIDADE (28001010063P4)
"52315" => CULTURA E SOCIEDADE (28001010049P1)
"205236" => Currículo, linguagens e inovações pedagógicas. (28001010091P8)
"202540" => DANÇA (28001010054P5)
"202541" => DESENVOLVIMENTO E GESTÃO SOCIAL (28001010055P1)
"203573" => DIFUSÃO DO CONHECIMENTO IFBA - SENAI/CIMATEC - LNCC - UNEB - UEFS (28001010064P0) (Programa em Rede)
"369" => DIREITO (28001010015P0)
"203574" => DIVERSIDADE ANIMAL (28001010065P7)
"204446" => Ecologia (28001010082P9)
"389" => ECOLOGIA E BIOMONITORAMENTO (28001010039P6)
"364" => ECONOMIA (28001010010P8)
"356" => EDUCAÇÃO (28001010001P9)
"202495" => ENERGIA E AMBIENTE (28001010053P9)
"368" => ENFERMAGEM (28001010014P3)
"388" => ENGENHARIA CIVIL (28001010038P0)
"206790" => ENGENHARIA CIVIL (28001010172P8)
"204713" => Engenharia de Estruturas (28001010087P0)
"387" => ENGENHARIA ELÉTRICA (28001010037P3)
"202866" => ENGENHARIA INDUSTRIAL (28001010062P8)
"204176" => ENGENHARIA INDUSTRIAL (28001010071P7)
"375" => ENGENHARIA QUÍMICA (28001010021P0)
"202752" => ENGENHARIA QUÍMICA - UFBA-UNIFACS (28001010059P7) (Programa em Rede)
"390" => ENSINO, FILOSOFIA E HISTÓRIA DAS CIÊNCIAS (28001010040P4) (Programa em Rede)
"52314" => ESTUDOS ÉTNICOS E AFRICANOS (28001010048P5)
"204472" => Estudos Interdisciplinares sobre a Universidade (28001010083P5)
"202542" => ESTUDOS INTERDISCIPLINARES SOBRE MULHERES, GÊNERO E FEMINISM (28001010056P8)
"204050" => FARMÁCIA (28001010067P0)
"392" => FILOSOFIA (28001010042P7)
"357" => FÍSICA (28001010002P5)
"204568" => Genética e Biodiversidade (28001010084P1)
"362" => GEOFÍSICA (28001010007P7)
"383" => GEOGRAFIA (28001010032P1)
"360" => GEOLOGIA (28001010005P4)
"204197" => GEOQUÍMICA: PETRÓLEO E MEIO AMBIENTE (28001010073P0)
"376" => HISTÓRIA (28001010022P6)
"379" => IMUNOLOGIA (28001010025P5)
"205242" => LETRAS (23001011069P5) (Programa em Rede)
"371" => LETRAS E LINGÜÍSTICA (28001010017P2)
"204344" => LÍNGUA E CULTURA (28001010078P1)
"204345" => LITERATURA E CULTURA (28001010079P8)
"358" => MATEMÁTICA (28001010003P1)
"204471" => Matemática em Rede Nacional (31075010001P2) (Programa em Rede)
"204410" => MATEMÁTICA - UFBA-UFAL (28001010081P2) (Programa em Rede)
"395" => MECATRÔNICA (28001010045P6)
"366" => MEDICINA E SAÚDE (28001010012P0)
"204248" => Meio Ambiente , Águas e Saneamento (28001010076P9)
"206784" => MICROBIOLOGIA (28001010171P1)
"205523" => Multicêntrico em Bioquímica e Biologia Molecular (33287015001P7) (Programa em Rede)
"204154" => MULTICÊNTRICO EM CIÊNCIAS FISIOLÓGICAS (33147019001P2) (Programa em Rede)
"205311" => Museologia (28001010093P0)
"380" => MÚSICA (28001010026P1)
"205237" => Música (28001010092P4)
"381" => ODONTOLOGIA E SAUDE (28001010029P0)
"365" => PATOLOGIA HUMANA (28001010011P4)
"204218" => PROCESSOS INTERATIVOS DOS ÓRGÃOS E SISTEMAS (28001010075P2)
"205435" => PROFARTES (41002016026P1) (Programa em Rede)
"206558" => PROFNIT - PROPRIEDADE INTELECTUAL E TRANSFERÊNCIA DE TECNOLOGIA PARA INOVAÇÃO (31102000001P6) (Programa em Rede)
"394" => PSICOLOGIA (28001010044P0)
"359" => QUÍMICA (28001010004P8)
"205489" => RELAÇÕES INTERNACIONAIS (28001010094P7)
"202753" => SAÚDE, AMBIENTE E TRABALHO (28001010060P5)
"367" => SAÚDE COLETIVA (28001010013P7)
"152282" => SAÚDE COLETIVA (28001010051P6)
"206684" => SAÚDE COLETIVA (28001010170P5)
"204610" => Segurança Pública, Justiça e Cidadania (28001010085P8)
"204714" => Zootecnia (28001010088P7)
*/

/*GET /sucupira/public/consultas/coleta/docente/listaDocente.jsf HTTP/1.1
Host: sucupira.capes.gov.br
Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*\/*;q=0.8
Referer: https://www.google.com.br/
Accept-Encoding: gzip, deflate, br
Accept-Language: pt-BR,pt;q=0.8,en-US;q=0.6,en;q=0.4*/


/*
* @param $program_id - string identificando o programa segundo o select do sistema sucupira
* @param $year - string identificando o ano
* @return $teachers - Array de objetos(stdClass) contendo nome, categoria e link para visualização
**/
function getProgramTeachers($program_id = "367", $year = "2017") {
    // $year = "2017";
    // $program_id = "367"; // Saúde Coletiva -- 57 registros
    // $program_id = "205551"; // Ciência da Computação -- 38 registros

    //$ckfile = tempnam ("/tmp", "CURLCOOKIE");
    $host = "https://sucupira.capes.gov.br";
    $ckfile = dirname(__FILE__) . '/cookie.txt';

    $ch = curl_init($host . '/sucupira/public/consultas/coleta/docente/listaDocente.jsf');
    curl_setopt($ch, CURLOPT_COOKIEJAR, $ckfile);
    curl_setopt($ch, CURLOPT_COOKIEFILE, $ckfile);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    $headers = [
        'Host: sucupira.capes.gov.br',
        'Connection: keep-alive',
        'Cache-Control: max-age=0',
        'Upgrade-Insecure-Requests: 1',
        'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36',
        'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*\/*;q=0.8',
        'Referer: https://google.com.br',
        'Accept-Encoding: gzip, deflate, br',
        'Accept-Language: pt-BR,pt;q=0.8,en-US;q=0.6,en;q=0.4',
    ];

    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    // get headers too with this line
    curl_setopt($ch, CURLOPT_HEADER, 1);
    $result = curl_exec($ch);

    // get cookie
    // multi-cookie variant contributed by @Combuster in comments
    preg_match_all('/^Set-Cookie:\s*([^;]*)/mi', $result, $matches);
    $cookies = array();
    foreach($matches[1] as $item) {
        parse_str($item, $cookie);
        $cookies = array_merge($cookies, $cookie);
    }

    $cookie = array_pop($cookies);

    $dom = new DOMDocument();
    libxml_use_internal_errors(true);
    $dom->loadHTML($result);
    $data = $dom->getElementById("javax.faces.ViewState");
    $viewState = str_replace(':', '%3A', $data->getAttribute('value'));

    curl_close($ch);

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $host . '/sucupira/public/consultas/coleta/docente/listaDocente.jsf');
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36');
    curl_setopt($ch, CURLOPT_POST, 1);

    /*form=form&
    form%3Aj_idt23%3Aano=" . $year . "&
    form%3Aj_idt23%3Ainst%3AvalueId=4354&
    form%3Aj_idt23%3Ainst%3Ainput=28001010%20UNIVERSIDADE%20FEDERAL%20DA%20BAHIA%20(UFBA)&
    form%3Aj_idt23%3Aj_idt99=205000&
    form%3Adocente=&
    form%3Acategoria=0&
    javax.faces.ViewState=1230730448448279533%3A4157464020732386004&
    javax.faces.source=form%3Aconsultar&
    javax.faces.partial.event=click&
    javax.faces.partial.execute=form%3Aconsultar%20%40component&
    javax.faces.partial.render=%40component&
    javax.faces.behavior.event=action&
    org.richfaces.ajax.component=form%3Aconsultar&
    AJAX%3AEVENTS_COUNT=1&
    javax.faces.partial.ajax=true*/

    $fields = array(
        'form' => "form",
        'form:j_idt23:ano' => "" . $year . "",
        'form:j_idt23:inst:valueId' => "4354",
        'form:j_idt23:inst:input' => "28001010 UNIVERSIDADE FEDERAL DA BAHIA (UFBA)",
        'form:j_idt23:j_idt42' => $program_id,
        //$select_id => "205000",
        'form:docente' => "",
        'form:categoria' => "3",
        'javax.faces.ViewState' => $viewState,
        'javax.faces.source' => "form:consultar",
        'javax.faces.partial.event' => "click",
        'javax.faces.partial.execute' => "form:consultar @component",
        'javax.faces.partial.render' => "@component",
        'javax.faces.behavior.event' => "action",
        'org.richfaces.ajax.component' => "form:consultar",
        'AJAX:EVENTS_COUNT' => "1",
        'javax.faces.partial.ajax' => "true",
    );
    $fields_string = http_build_query($fields);

    //curl_setopt($ch, CURLOPT_POSTFIELDS, $fields_string);  //Post Fields
    curl_setopt($ch, CURLOPT_POSTFIELDS, "form=form&form%3Aj_idt23%3Aano=" . $year . "&form%3Aj_idt23%3Ainst%3AvalueId=&form%3Aj_idt23%3Ainst%3Ainput=ufba&form%3Aj_idt23%3Ainst%3Alistbox=4354&form%3Adocente=&form%3Acategoria=0&javax.faces.ViewState=" . $viewState . "&javax.faces.source=form%3Aj_idt23%3Ainst%3Alistbox&javax.faces.partial.event=change&javax.faces.partial.execute=form%3Aj_idt23%3Ainst%3Alistbox%20form%3Aj_idt23%3Ainst&javax.faces.partial.render=form%3Aj_idt23%3Ainst%3Ainst%20form%3Aj_idt23%3Ainst%3AvalueId%20form%3Aj_idt23%3Aprograma&javax.faces.behavior.event=valueChange&AJAX%3AEVENTS_COUNT=1&javax.faces.partial.ajax=true");  //Post Fields

    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5000);
    curl_setopt($ch, CURLOPT_VERBOSE, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 5000);

    $headers = [
        'Host: sucupira.capes.gov.br',
        'Connection: keep-alive',
        'Faces-Request: partial/ajax',
        'Origin: https://sucupira.capes.gov.br',
        'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36',
        'Content-type: application/x-www-form-urlencoded;charset=UTF-8',
        'Accept: */*',
        'Referer: https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/docente/listaDocente.jsf',
        'Accept-Encoding: gzip, deflate, br',
        'Accept-Language: pt-BR,pt;q=0.8,en-US;q=0.6,en;q=0.4',
        //'Cookie: ' . $cookie,
    ];

    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_COOKIEJAR, $ckfile);
    curl_setopt($ch, CURLOPT_COOKIEFILE, $ckfile);

    $data = curl_exec($ch);

    curl_setopt($ch, CURLOPT_POSTFIELDS, "form=form&form%3Aj_idt23%3Aano=" . $year . "&form%3Aj_idt23%3Ainst%3AvalueId=&form%3Aj_idt23%3Ainst%3Ainput=ufba&form%3Aj_idt23%3Ainst%3Alistbox=4354&form%3Adocente=&form%3Acategoria=0&javax.faces.ViewState=". $viewState . "&javax.faces.source=form%3Aj_idt23%3Ainst%3Alistbox&javax.faces.partial.event=change&javax.faces.partial.execute=form%3Aj_idt23%3Ainst%3Alistbox%20form%3Aj_idt23%3Ainst&javax.faces.partial.render=form%3Aj_idt23%3Ainst%3Ainst%20form%3Aj_idt23%3Ainst%3AvalueId%20form%3Aj_idt23%3Aprograma&javax.faces.behavior.event=valueChange&AJAX%3AEVENTS_COUNT=1&javax.faces.partial.ajax=true");  //Post Fields

    $headers = [
        'Host: sucupira.capes.gov.br',
        'Connection: keep-alive',
        'Faces-Request: partial/ajax',
        'Origin: https://sucupira.capes.gov.br',
        'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36',
        'Content-type: application/x-www-form-urlencoded;charset=UTF-8',
        'Accept: */*',
        'Referer: https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/docente/listaDocente.jsf',
        'Accept-Encoding: gzip, deflate, br',
        'Accept-Language: pt-BR,pt;q=0.8,en-US;q=0.6,en;q=0.4',
        //'Cookie: ' . $cookie,
    ];

    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $data = curl_exec($ch);

    /*$fp = fopen('test.txt', 'w');
    fwrite($fp, $data);
    fclose($fp);*/

    $dom = new DOMDocument();
    $dom->loadHTML($data);
    $select_id = $dom->getElementsByTagName('select')->item(1)->getAttribute('name');

    curl_setopt($ch, CURLOPT_POSTFIELDS, "form=form&form%3Aj_idt23%3Aano=" . $year . "&form%3Aj_idt23%3Ainst%3AvalueId=4354&form%3Aj_idt23%3Ainst%3Ainput=28001010%20UNIVERSIDADE%20FEDERAL%20DA%20BAHIA%20(UFBA)&" . $select_id . "=" . $program_id . "&form%3Adocente=&form%3Acategoria=0&javax.faces.ViewState=" . $viewState . "&javax.faces.source=form%3Aconsultar&javax.faces.partial.event=click&javax.faces.partial.execute=form%3Aconsultar%20%40component&javax.faces.partial.render=%40component&javax.faces.behavior.event=action&org.richfaces.ajax.component=form%3Aconsultar&AJAX%3AEVENTS_COUNT=1&javax.faces.partial.ajax=true");  //Post Fields

    $headers = [
        'Host: sucupira.capes.gov.br',
        'Connection: keep-alive',
        'Faces-Request: partial/ajax',
        'Origin: https://sucupira.capes.gov.br',
        'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36',
        'Content-type: application/x-www-form-urlencoded;charset=UTF-8',
        'Accept: */*',
        'Referer: https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/docente/listaDocente.jsf',
        'Accept-Encoding: gzip, deflate, br',
        'Accept-Language: pt-BR,pt;q=0.8,en-US;q=0.6,en;q=0.4',
    ];

    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $data = curl_exec($ch);

    $dom = new DOMDocument();
    $dom->loadHTML($data);
    $tbody = $dom->getElementsByTagName('tbody')->item(0);

    $teachers = array();
    foreach ($tbody->getElementsByTagName('tr') as $key => $tr) {
        $tr->getElementsByTagName('td');
        $teachers[] = (object)[
            "nome" => $tr->childNodes->item(0)->nodeValue,
            "categoria" => $tr->childNodes->item(2)->nodeValue,
            "link" => $host . $tr->getElementsByTagName('a')->item(0)->getAttribute('href'),
        ];
    }

    $div_paging = $tbody->parentNode->parentNode->childNodes->item(2);
    $select_paging = $div_paging->getElementsByTagName('select')->item(0);

    $select_paging_id = $select_paging->getAttribute('name');

    $qt_pages = $select_paging->childNodes->length;

    for ($i = 2; $i <= $qt_pages; $i++) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, "form=form&form%3Aj_idt23%3Aano=" . $year . "&form%3Aj_idt23%3Ainst%3AvalueId=4354&form%3Aj_idt23%3Ainst%3Ainput=28001010%20UNIVERSIDADE%20FEDERAL%20DA%20BAHIA%20(UFBA)&" . $select_id . "=" . $program_id . "&form%3Adocente=&form%3Acategoria=0&" . $select_paging_id . "=" . $i . "&javax.faces.ViewState=" . $viewState . "&javax.faces.source=" . $select_paging_id . "&javax.faces.partial.event=change&javax.faces.partial.execute=" . $select_paging_id . "%20%40component&javax.faces.partial.render=%40component&javax.faces.behavior.event=change&org.richfaces.ajax.component=" . $select_paging_id . "&AJAX%3AEVENTS_COUNT=1&javax.faces.partial.ajax=true");  //Post Fields
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        $data = curl_exec($ch);

        $dom = new DOMDocument();
        $dom->loadHTML($data);
        $tbody = $dom->getElementsByTagName('tbody')->item(0);

        foreach ($tbody->getElementsByTagName('tr') as $key => $tr) {
            $tr->getElementsByTagName('td');
            $teachers[] = (object)[
                "nome" => $tr->childNodes->item(0)->nodeValue,
                "categoria" => $tr->childNodes->item(2)->nodeValue,
                "link" => $host . $tr->getElementsByTagName('a')->item(0)->getAttribute('href'),
            ];
        }
    }

    /*$fp = fopen('test.txt', 'w');
    fwrite($fp, $data);
    fclose($fp);*/

    $header = curl_getinfo($ch, CURLINFO_HEADER_OUT);
    curl_close($ch);

    return $teachers;
}

// Chamadas da função acima
$return = getProgramTeachers(); // $program_id = 367
var_dump($return);
echo "</br>";
echo "</br>";
var_dump("---------------------------------------------------------------------------------------------------------------");
echo "</br>";
echo "</br>";
$return = getProgramTeachers("205000"); // $program_id = 205000
var_dump($return);
echo "</br>";
echo "</br>";
var_dump("---------------------------------------------------------------------------------------------------------------");
echo "</br>";
echo "</br>";
$return = getProgramTeachers("205551"); // $program_id = 205551
var_dump($return);
